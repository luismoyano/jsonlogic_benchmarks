name: ruby_benchmarks

on:
  # Run weekly on Sundays at 00:00 UTC
  schedule:
    - cron: '0 0 * * 0'
  
  # Allow manual trigger
  workflow_dispatch:

jobs:
  # Download test suites once and share via artifact
  setup:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download test suites
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          chmod +x scripts/download_tests.sh
          ./scripts/download_tests.sh

      - name: Upload test suites artifact
        uses: actions/upload-artifact@v4
        with:
          name: test-suites
          path: tests/
          retention-days: 1

  benchmark:
    needs: setup
    runs-on: ${{ matrix.os }}
    
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest]
        ruby-version: ['2.7', '3.1', '3.2', '3.3', '3.4', '4.0']

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download test suites artifact
        uses: actions/download-artifact@v4
        with:
          name: test-suites
          path: tests/

      - name: Set up Ruby ${{ matrix.ruby-version }}
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: ${{ matrix.ruby-version }}
          bundler-cache: false

      - name: Run benchmark
        run: ruby benchmark_ruby/performance_benchmark.rb

      - name: Upload benchmark results
        uses: actions/upload-artifact@v4
        with:
          name: results-${{ matrix.os }}-ruby-${{ matrix.ruby-version }}
          path: benchmark_ruby/results/
          retention-days: 1

  # Collect all results and commit in a single job to avoid conflicts
  commit-results:
    needs: benchmark
    runs-on: ubuntu-latest
    if: always() && needs.benchmark.result != 'cancelled'
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download all benchmark results
        uses: actions/download-artifact@v4
        with:
          pattern: results-*
          path: downloaded-results/
          merge-multiple: false

      - name: Merge results into results directory
        run: |
          # Create today's date folder
          DATE=$(date +%Y-%m-%d)
          mkdir -p benchmark_ruby/results/$DATE
          mkdir -p benchmark_ruby/results/latest
          
          # Copy all results from artifacts
          for dir in downloaded-results/results-*/; do
            if [ -d "$dir" ]; then
              # Find the date folder and latest folder in each artifact
              for date_dir in "$dir"*/; do
                if [ -d "$date_dir" ]; then
                  dirname=$(basename "$date_dir")
                  if [ "$dirname" = "latest" ]; then
                    cp -f "$date_dir"*.json benchmark_ruby/results/latest/ 2>/dev/null || true
                  elif [[ "$dirname" =~ ^[0-9]{4}-[0-9]{2}-[0-9]{2}$ ]]; then
                    mkdir -p "benchmark_ruby/results/$dirname"
                    cp -f "$date_dir"*.json "benchmark_ruby/results/$dirname/" 2>/dev/null || true
                  fi
                fi
              done
            fi
          done
          
          echo "Results merged:"
          find benchmark_ruby/results -name "*.json" | head -20

      - name: Commit and push results
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"
          git add benchmark_ruby/results/
          git diff --staged --quiet || git commit -m "benchmark: Ruby $(date +%Y-%m-%d)"
          git push
